<pre>
  OEP: 6
  Title: API for dApps (dAPI)
  Author: Matus Zamborsky <zamborsky@gmail.com>
  Type: Standard
  Status: Draft
  Created: 2018-08-03
</pre>

==Abstract==

A Javascript API is proposed for dApps development. This dAPI allows dApps to communicate with Ontology blockchain and make requests for transfers, ONT ID registration and others, without requiring users to trust the dApp itself. The issue of trust is shifted to the dAPI provider.

==Motivation==

Currently a dApp will use one of the SDKs (Typescript, Java, Python, ...) to communicate with Ontology network. This setup has two main disadvantages:

1. User of the dApp will have to trust the dApp developer with his private keys and that information about transfers mediated through the dApp are legitimate.

2. Although the SDKs are very powerful, they are hard to use. A more streamlined API will allow developers to focus on the application itself.

==Specification==
This proposal makes use of the following functions and definitions:

*'''SDK''', a software development kit implementing low level communication with the network and providing high level interface for dApps.

*'''SHA256''', a well-known hashing algorithm that takes an arbitrary number of bytes as input and deterministically yields a 32-byte hash.

*'''dApp''', an application with decentralized characteristics running in web environment. The application uses Ontology network for value transfers, contracts enforcing and identification between participants.

*'''dAPI''', the API for dApps this OEP is proposing.

*'''dAPI provider''', an implementation of the dAPI in the form of web browser plugin or other means, where a user interaction with the provider can be injected into api call workflow (e.g.: confirming transfer)

===dAPI grouping===
Although this proposal is bringing clear and simple API for the dApps, the individual functions can be divided into these groups:

* '''Network''', a thin wrapper around the Ontology Node API, masking the complexity of rpc/rest calls and websockets with Request-Response facade.

* '''Runtime.*''', a main point of integration with the dAPI provider, where the issue of trust is shifted from dApp to dApp provider.

* '''Runtime.Asset''', functions for transfering assets between user account and others.

* '''Runtime.Identity''', functions for interacting with own ONT-ID identity.

* '''Runtime.SmartContract''', a high level wrapper around the Smart Contract invocation and deployment.

* '''Runtime.Message''', functions for signing arbitrary messages.

* '''Utils''', a group of utility function for encoding and decoding the data from/to blockchain.

===Account/Identity management and transaction signing ===
Because dAPI shifts the issue of trust from dApp to dApp provider, all account and identity management is external to the dApp. Therefore there are no methods which directly handle private keys. The dApp won't need to sign the transaction itself. 

Any time dApp makes a call that requires a private key to sign something (makeTransfer, sign), dApp provider will inform user about the action and prompt him for permission.

===Complex structures===
API specification is a complex document. Every method has some inputs and outputs. Although we use the primitive types (numbers, strings, booleans) whenever possible, there are places where a complex object is required. To preciselly describe the structure of those objects, we'd chosen Typescript syntax.

<pre>
type Network = 'MAIN' | 'TEST' | 'PRIVATE';
type Asset = 'ont' | 'ong';

interface OntIdAttribute {
    key: string;
    type: string;
    value: string;
}

interface OntIdDDO {
    ...
}
</pre>

===Network===
A network API consists of:

<pre>
function getGenerateBlockTime(): Promise<number | null>
function getNodeCount(): Promise<number>
function getBlockHeight(): Promise<number>
function getMerkleProof(txHash: string): Promise<MerkleProof>
function getStorage(constractAddress: string, key: string): Promise<string>
function getAllowance(asset: Asset, fromAddress: string, toAddress: string): Promise<BigNumber>
function getBlock(block: number | string): Promise<Block>
function getTransaction(txHash: string): Promise<Transaction>
function getNetwork(): Network
function getBalance(address: string): Promise<Balance>
</pre>

For further explanation about the wrapped method consult https://ontio.github.io/documentation/restful_api_en.html . The types '''Transaction''', '''Block''', '''MerkleProof''' and '''Balance''' corresponds to the exact object returned from Ontology blockchain. '''BigNumber''' corresponds to a implementation of BigNumbers.

===Runtime.Asset===
A primary focus of Runtime.Asset API is to enumerate the addresses under user control and initiate a transfer. The request needs to be confirmed by the user.

====getOwnAccounts====
<pre>
function getOwnAccounts(): string[]
</pre>

Returns all the accounts associated with logged in user.

====getDefaultAccount====
<pre>
function getDefaultAccount(): string | null
</pre>
Returns currently selected account of logged in user or null if there is none.

====makeTransfer====
<pre>
function makeTransfer(sender: string, recipient: string, asset: Asset, amount: BigNumber): Promise<void>
</pre>

Initiates a transfer of <code>amount asset</code> from <code>sender</code> account to <code>recipient</code> account. The <code>sender</code> must be one of the accounts returned by <code>getOwnAccounts</code>.


===Runtime.Identity===
A primary focus of Runtime.Identity API is to enumerate the ONT ID identities under user control and initiate a process of adding/removing attribute from the identity. The request needs to be confirmed by the user. 

====getOwnIdentities====
<pre>
function getOwnIdentities(): string[]
</pre>

Returns all the identites associated with logged in user.

====getDefaultIdentity====
<pre>
function getDefaultIdentity(): string | null
</pre>

Returns currently selected identity of logged in user or null if there is none.

====getDDO====
<pre>
function getDDO(ontId: string): Promise<OntIdDDO>
</pre>

Queries Description Object of the identity. This operation is not signed and therefore does not require user interaction.

====getAttributes====
<pre>
function getAttributes(ontId: string): Promise<OntIdAttribute[]>
</pre>

Queries attributes attached to the identity. This operation is not signed and therefore does not require user interaction.


====addAttributes====
<pre>
function addAttributes(ontId: string, attributes: OntIdAttribute[]): Promise<void>
</pre>

Adds attributes to the identity. The <code>ontId</code> must be one of the identities returned by <code>getOwnIdentities</code>.

====removeAttributes====
<pre>
function removeAttribute(ontId: string, key: string): Promise<void>
</pre>

Removes attribute from the identity. The <code>ontId</code> must be one of the identities returned by <code>getOwnIdentities</code>.


===Runtime.Message===
This API deals with arbitrary message signing and verification. For security reasons, the API will prepend the supplied the message with known prefix or typed messages needs to be used.

====signMessageHash====
<pre>
function signMessageHash(messageHash: string, accountOrIdentity: string): Promise<string>
</pre>

Initiates signing of arbitrary <code>messageHash</code> by the account or identity. The <code>accountOrIdentity</code> '''must''' be one of the accounts returned by <code>getOwnAccounts</code> or identities returned by <code>getOwnIdentities</code>.

This method does not require the dApp to disclose the message itself, only the hash. 

Because malicious dApp can hash a real prepared transfer transaction and plant it for signing, that posses a risk to the user.
Therefore the hash is prepended with known string '''Ontology message:''', hashed with '''SHA-256''' and only this hash is put for signing.

====verifyMessageHash====
<pre>
function verifyMessageHash(messageHash: string, accountOrIdentity: string, signature: string): Promise<boolean>
</pre>

Verifies that the <code>signature</code> is created by the account or identity over <code>messageHash</code>. The <code>accountOrIdentity</code> '''does not''' need to be one of the accounts returned by <code>getOwnAccounts</code> or identities returned by <code>getOwnIdentities</code>.

This method does not require the dApp to disclose the message itself, only the hash. 


====signMessage====
<pre>
function signMessage(message: string, accountOrIdentity: string): Promise<string>
</pre>

Initiates signing of text <code>message</code> by the account or identity. The <code>accountOrIdentity</code> '''must''' be one of the accounts returned by <code>getOwnAccounts</code> or identities returned by <code>getOwnIdentities</code>.

This method provide the dAPI provider with the message body, which it should display to the user prior to signing (e.g.: a contract to sign). Signing is done on '''SHA-256''' hash of the message.

====verifyMessage====
<pre>
function verifyMessage(message: string, accountOrIdentity: string, signature: string): Promise<boolean>
</pre>

Verifies that the <code>signature</code> is created by the account or identity over text <code>message</code>. The <code>accountOrIdentity</code> '''does not''' need to be one of the accounts returned by <code>getOwnAccounts</code> or identities returned by <code>getOwnIdentities</code>.

Verification is done on '''SHA-256''' hash of the message.


==Rationale==

==Test Cases==

==Implementation==

